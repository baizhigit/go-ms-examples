# Пример многослойной архитектуры (Clean Architecture)

Этот проект демонстрирует реализацию многослойной (чистой) архитектуры на примере сервиса для регистрации наблюдений НЛО.

## Архитектура проекта

Проект построен в соответствии с принципами чистой архитектуры и разделен на следующие слои:

### 1. API слой (Адаптеры)
- Располагается в `internal/api`
- Отвечает за обработку внешних запросов (gRPC)
- Преобразует данные из внешнего формата (proto) во внутренние модели
- Делегирует выполнение бизнес-логики в сервисный слой

### 2. Сервисный слой (Use Cases)
- Располагается в `internal/service`
- Содержит бизнес-логику приложения
- Определяет интерфейсы репозиториев
- Не зависит от внешних деталей (БД, протоколы и т.д.)

### 3. Репозиторный слой (Адаптеры)
- Располагается в `internal/repository`
- Отвечает за доступ к данным
- Реализует интерфейсы, определенные в сервисном слое
- Скрывает детали хранения данных от остальных слоев
- Имеет собственные модели данных (`internal/repository/model`), отличные от доменных моделей
- Использует конвертеры для преобразования между моделями репозитория и доменными моделями

### 4. Модели (Entities)
- Располагаются в `internal/model`
- Представляют основные бизнес-сущности
- Не зависят от других слоев

### 5. Конвертеры
- Располагаются в `internal/converter` и `internal/repository/converter`
- Отвечают за преобразование данных между различными форматами
- Обеспечивают изоляцию между слоями
- Включают:
  - Конвертеры между Proto и доменными моделями (в `internal/converter`)
  - Конвертеры между доменными моделями и моделями репозитория (в `internal/repository/converter`)

## Преимущества данной архитектуры

1. **Разделение ответственностей** - каждый слой имеет четко определенную ответственность
2. **Изоляция зависимостей** - зависимости направлены внутрь (к ядру приложения)
3. **Тестируемость** - слои можно тестировать изолированно
4. **Гибкость** - можно легко заменить конкретные реализации (например, базу данных)
5. **Устойчивость к изменениям** - изменения в одном слое минимально влияют на другие

## Поток данных

1. gRPC запрос попадает в API слой
2. API слой конвертирует данные из proto в доменную модель (используя `internal/converter`)
3. API слой вызывает методы сервисного слоя
4. Сервисный слой применяет бизнес-логику и обращается к репозиторию
5. Репозиторий конвертирует доменные модели в модели репозитория (используя `internal/repository/converter`)
6. Репозиторий выполняет операции с данными и возвращает результат
7. Репозиторий конвертирует результат из моделей репозитория обратно в доменные модели
8. Сервисный слой обрабатывает результат и возвращает его в API слой
9. API слой конвертирует доменную модель обратно в proto и отвечает клиенту

## Доступные методы API

- **Create**: Создание нового наблюдения НЛО
- **Get**: Получение наблюдения по UUID
- **Update**: Обновление существующего наблюдения
- **Delete**: Мягкое удаление наблюдения (установка временной метки удаления)

## Примеры запросов с использованием grpcurl

Перед выполнением запросов запустите сервер:

```bash
go run cmd/grpc_server/main.go
```

### Создание наблюдения (Create)

```bash
bin/grpcurl -plaintext -d '{
  "info": {
    "observed_at": "2023-06-15T20:30:00Z",
    "location": "Москва, Кремль",
    "description": "Яркий объект в форме треугольника",
    "color": "зеленый",
    "sound": true,
    "duration_seconds": 300
  }
}' localhost:50051 ufo.v1.UFOService/Create
```

Ответ:
```json
{
  "uuid": "некоторый-uuid"
}
```

### Получение наблюдения (Get)

```bash
bin/grpcurl -plaintext -d '{
  "uuid": "некоторый-uuid"
}' localhost:50051 ufo.v1.UFOService/Get
```

Ответ:
```json
{
  "sighting": {
    "uuid": "некоторый-uuid",
    "info": {
      "observed_at": "2023-06-15T20:30:00Z",
      "location": "Москва, Кремль",
      "description": "Яркий объект в форме треугольника",
      "color": "зеленый",
      "sound": true,
      "duration_seconds": 300
    },
    "created_at": "2023-07-01T12:00:00Z",
    "updated_at": null,
    "deleted_at": null
  }
}
```

### Обновление наблюдения (Update)

```bash
bin/grpcurl -plaintext -d '{
  "uuid": "некоторый-uuid",
  "update_info": {
    "description": "Яркий объект в форме диска",
    "color": "красный"
  }
}' localhost:50051 ufo.v1.UFOService/Update
```

Ответ:
```json
{}
```

### Удаление наблюдения (Delete)

```bash
bin/grpcurl -plaintext -d '{
  "uuid": "некоторый-uuid"
}' localhost:50051 ufo.v1.UFOService/Delete
```

Ответ:
```json
{}
```

## Запрос списка методов и их описания

```bash
bin/grpcurl -plaintext localhost:50051 list
bin/grpcurl -plaintext localhost:50051 describe ufo.v1.UFOService
```

## Структура проекта

```
.
├── cmd
│   └── grpc_server       # Точка входа gRPC сервера
├── internal
│   ├── api               # API слой (адаптеры)
│   │   └── ufo
│   │       └── v1        # Реализация gRPC API
│   ├── converter         # Конвертеры между форматами данных
│   ├── model             # Доменные модели (entities)
│   ├── repository        # Репозиторный слой (адаптеры)
│   │   ├── converter     # Конвертеры для репозитория
│   │   ├── model         # Модели репозитория
│   │   └── ufo           # Реализация репозитория
│   └── service           # Сервисный слой (use cases)
│       └── ufo           # Реализация бизнес-логики
├── pkg
│   └── proto             # Protobuf определения
└── ...
```

## Особенности реализации

- **Nullable fields**: Используются указатели для опциональных полей
- **Soft delete**: Реализовано мягкое удаление через установку временной метки
- **Error handling**: Ошибки из доменной модели преобразуются в соответствующие gRPC коды ошибок
- **Concurrency**: Используется sync.RWMutex для безопасного доступа к данным
- **Многоуровневые модели**: В проекте используются три уровня моделей:
  - Proto-модели: для внешнего API
  - Доменные модели: для бизнес-логики
  - Модели репозитория: для хранения данных
- **Изоляция слоев через конвертеры**: Каждый слой взаимодействует только со своими моделями, используя конвертеры для преобразования данных между слоями

## Тестирование

Проект включает юнит-тесты для API и сервисного слоев с использованием моков и testify/suite.

### Тесты API слоя

API-тесты расположены в `internal/api/ufo/v1/*_test.go` и проверяют:
- Корректное преобразование входных данных
- Правильную обработку успешных сценариев
- Корректную обработку ошибок от сервисного слоя
- Правильное формирование ответов

### Тесты сервисного слоя

Тесты сервисного слоя расположены в `internal/service/ufo/*_test.go` и проверяют:
- Бизнес-логику обработки запросов
- Корректную обработку ошибок от репозитория
- Правильное взаимодействие с репозиторием

### Команды для запуска тестов

В проекте настроены две команды в Taskfile.yaml для работы с тестами:

#### 1. Запуск тестов с измерением покрытия

```bash
task test-coverage
```

Эта команда:
- Запускает тесты для всех пакетов в проекте
- Измеряет покрытие кода тестами для API и сервисного слоев
- Выводит общую статистику покрытия

#### 2. Генерация HTML-отчета о покрытии

```bash
task coverage:html
```

Эта команда:
- Запускает тесты с измерением покрытия
- Генерирует HTML-отчет с детальной информацией о покрытии кода
- Автоматически открывает отчет в браузере (для macOS/Linux)

Покрытие кода тестами составляет 100% для API и сервисного слоев, что обеспечивает высокую надежность и стабильность проекта.
